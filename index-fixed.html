<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Animus Helix — Hardened</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React / ReactDOM (pinned prod UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Framer Motion UMD (pinned) -->
  <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

  <!-- Babel standalone (only for JSX in-browser; keep for prototipo) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root { --bg:#020408; --gold:#c5a059; --cyan:#00ffff; }
    html,body,#root { height:100%; }
    body { margin:0; background:var(--bg); color:#fff; font-family: 'Share Tech Mono', monospace; }
    #error-log { display:none; position:fixed; inset:12px; z-index:9999; background:rgba(0,0,0,0.75); color:#ff6b6b; font-family:monospace; padding:12px; border-radius:8px; }
    @media (prefers-reduced-motion: reduce) {
      .animate-float { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="error-log" aria-live="assertive"></div>

  <script type="text/babel">
    // Global error catcher: mostra l'errore a schermo invece del white screen
    window.onerror = function(msg, url, line, col, error) {
      const el = document.getElementById('error-log');
      el.style.display = 'block';
      el.innerHTML = `<strong>CRITICAL ERROR</strong><br>${msg}<br>Line: ${line}:${col}<br><pre style="white-space:pre-wrap">${error && error.stack ? error.stack : ''}</pre>`;
      console.error(msg, url, line, col, error);
      return false;
    };

    try {
      // Rilevamento robusto di Framer Motion (diverse possibili esposizioni globali)
      const FM = window.Motion || window.FramerMotion || window.framerMotion || window.framerMotion || null;

      // Fallback "soft" per motion: usa semplici elementi React se Framer non è disponibile
      const createFallback = (tag) => (props) => {
        const { children, ...rest } = props || {};
        return React.createElement(tag, rest, children);
      };
      const fallbackMotion = {
        div: createFallback('div'),
        p: createFallback('p'),
        span: createFallback('span'),
        button: createFallback('button'),
      };
      const fallbackAnimatePresence = ({ children }) => React.createElement(React.Fragment, null, children);

      // Estraggiamo le primitive (safe)
      const { motion = fallbackMotion, AnimatePresence = fallbackAnimatePresence } = FM || { motion: fallbackMotion, AnimatePresence: fallbackAnimatePresence };

      // Shortcuts React
      const { useState, useEffect } = React;

      // Dati di esempio (come nel tuo prototipo)
      const CONFIG = { spacing: 160, radius: 280, rotationSpeed: 30 };
      const timelineData = Array.from({ length: 25 }, (_, i) => {
        const year = 1995 + i;
        return {
          year,
          title: i % 2 === 0 ? "GENETIC_MEMORY" : "FRAGMENT_LOST",
          status: i % 3 === 0 ? "CORRUPTED" : "SYNCED",
          desc: "Sequence loaded successfully. Genetic markers indicate high precursor activity."
        };
      });

      function App() {
        const [activeIndex, setActiveIndex] = useState(10);
        const targetX = -(activeIndex * CONFIG.spacing);

        // small performance hint: avoid animating blur frequently — will-change transform for floating
        useEffect(() => {
          document.documentElement.style.setProperty('--active-index', activeIndex);
        }, [activeIndex]);

        return (
          React.createElement('div', { className: "h-screen w-full relative overflow-hidden bg-[radial-gradient(circle_at_50%_50%,rgba(20,30,48,0.4)_0%,#020408_80%)] animus-bg" },
            // HUD overlay
            React.createElement('div', { className: "absolute inset-0 pointer-events-none p-8 flex flex-col justify-between z-50" },
              React.createElement('div', { className: "flex justify-between items-start opacity-70" },
                React.createElement('div', null,
                  React.createElement('h1', { className: "text-3xl font-serif text-[#c5a059] tracking-[0.2em] drop-shadow-[0_0_10px_rgba(197,160,89,0.8)]" },
                    "ANIMUS ",
                    React.createElement('span', { className: "text-white text-sm tracking-widest block font-sans opacity-50" }, "OMEGA PROTOCOL // V.4.0")
                  )
                ),
                React.createElement('div', { className: "text-right text-xs text-[#00ffff] space-y-1" },
                  React.createElement('p', null, "MEM_USAGE: 4024 TB"),
                  React.createElement('p', null, "SYNC_RATE: 98.4%"),
                  React.createElement('div', { className: "w-32 h-1 bg-[#00ffff]/20 mt-2" },
                    React.createElement('div', { className: "w-[80%] h-full bg-[#00ffff] animate-pulse" })
                  )
                )
              ),
              React.createElement('div', { className: "flex justify-between items-end opacity-50 text-[10px] tracking-widest text-gray-400" },
                React.createElement('div', null, "COORD: 45.4408° N, 12.3155° E"),
                React.createElement('div', null, "SUBJECT: 17")
              )
            ),

            // 3D viewport (simplified: motion fallback will still render)
            React.createElement('div', { className: "absolute inset-0 flex items-center justify-center scene-container", style: { perspective: 800 } },
              motion.div ?
                motion.div({
                  className: "relative h-full",
                  initial: false,
                  animate: { x: targetX, rotateX: 10, rotateZ: -5 },
                  transition: { type: "spring", stiffness: 100, damping: 20, mass: 1 },
                  style: { transformStyle: 'preserve-3d', width: '100%' },
                  children: timelineData.map((item, index) => {
                    const angle = index * CONFIG.rotationSpeed;
                    const rad = (angle * Math.PI) / 180;
                    const x = index * CONFIG.spacing;
                    const y = Math.sin(rad) * CONFIG.radius;
                    const z = Math.cos(rad) * CONFIG.radius;
                    const isActive = index === activeIndex;
                    const dist = Math.abs(index - activeIndex);
                    const scale = isActive ? 1.3 : Math.max(0.6, 1 - dist * 0.15);
                    const opacity = Math.max(0.1, 1 - dist * 0.25);
                    const blur = isActive ? 0 : Math.min(10, dist * 2);

                    // wrapper element (motion.div or fallback)
                    const Wrapper = motion.div || fallbackMotion.div;

                    return Wrapper({
                      key: item.year,
                      onClick: () => setActiveIndex(index),
                      className: "absolute top-1/2 left-1/2 cursor-pointer group",
                      style: {
                        transform: `translate3d(${x}px, ${y}px, ${z}px) rotateY(${-20}deg)`,
                        zIndex: 100 - dist,
                      },
                      animate: { rotateX: -angle },
                      transition: { type: "spring", stiffness: 100 },
                      children:
                        React.createElement('div', {
                          className: `relative w-64 h-40 rounded-lg overflow-hidden flex flex-col p-4 ${isActive ? 'bg-[rgba(197,160,89,0.15)] border border-[#c5a059] z-50' : 'bg-[rgba(10,20,30,0.6)] border border-[rgba(255,255,255,0.1)]'}`,
                          style: { transform: `scale(${scale})`, opacity, filter: `blur(${blur}px)`, boxShadow: isActive ? '0 0 20px rgba(197,160,89,0.2)' : '0 4px 30px rgba(0,0,0,0.5)' }
                        },
                          isActive ? React.createElement('div', { className: "absolute inset-0 bg-[linear-gradient(0deg,rgba(255,255,255,0.02),transparent)] scanlines opacity-30" }) : null,
                          React.createElement('div', { className: "flex justify-between items-center border-b border-white/10 pb-2 mb-2" },
                            React.createElement('span', { className: `text-3xl font-bold ${isActive ? 'text-[#c5a059]' : 'text-gray-400'}` }, item.year),
                            React.createElement('div', { className: `w-2 h-2 rounded-full ${item.status === 'CORRUPTED' ? 'bg-red-500' : 'bg-[#00ffff]'}` })
                          ),
                          React.createElement('div', { className: "flex-1" },
                            React.createElement('h3', { className: "text-xs text-gray-300 tracking-widest mb-1" }, item.title),
                            isActive ? React.createElement('p', { className: "text-[10px] text-[#c5a059] leading-relaxed font-sans" }, item.desc) : null
                          ),
                          React.createElement('div', { className: "flex justify-between items-end mt-auto opacity-50" },
                            React.createElement('span', { className: "text-[8px]" }, `SEQ_${index}02`),
                            React.createElement('div', { className: "flex gap-1" },
                              [1,2,3].map(d => React.createElement('div', { key: d, className: "w-1 h-3 bg-white/40" }))
                            )
                          )
                        )
                    });
                  })
                }) :
                // If motion.div undefined, render simple fallback message
                React.createElement('div', { className: "text-center text-sm text-gray-400" }, "Rendering fallback (Framer Motion non disponibile).")
            ),

            // Controls
            React.createElement('div', { className: "absolute bottom-12 w-full flex justify-center gap-8 z-50" },
              React.createElement('button', {
                onClick: () => setActiveIndex(Math.max(0, activeIndex - 1)),
                className: "px-8 py-2 bg-black/50 border border-[#00ffff]/30 text-[#00ffff] hover:bg-[#00ffff]/10 hover:border-[#00ffff] transition-all rounded backdrop-blur-md uppercase text-xs tracking-[0.2em]"
              }, "< Rewind"),
              React.createElement('button', {
                onClick: () => setActiveIndex(Math.min(timelineData.length - 1, activeIndex + 1)),
                className: "px-8 py-2 bg-black/50 border border-[#c5a059]/30 text-[#c5a059] hover:bg-[#c5a059]/10 hover:border-[#c5a059] transition-all rounded backdrop-blur-md uppercase text-xs tracking-[0.2em]"
              }, "Forward >")
            )
          )
        );
      }

      // Mount React 18 root with try/catch
      const rootEl = document.getElementById('root');
      const root = ReactDOM.createRoot(rootEl);
      root.render(React.createElement(App));

      // Informational: mostra messaggio se Framer Motion non è stato trovato (utile in deploy)
      if (!FM) {
        const el = document.getElementById('error-log');
        el.style.display = 'block';
        el.innerHTML = '<strong>NOTICE:</strong> Framer Motion global not detected. Running with graceful fallbacks. Check CDN or use bundled build for full effects.';
        setTimeout(() => { el.style.display = 'none'; }, 4500);
      }

    } catch (err) {
      const el = document.getElementById('error-log');
      el.style.display = 'block';
      el.innerHTML = `<strong>SETUP ERROR:</strong><br>${err.message}<pre style="white-space:pre-wrap">${err.stack}</pre>`;
      console.error(err);
    }
  </script>
</body>
</html>
